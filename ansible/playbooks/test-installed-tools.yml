---
# Test System-Installed Tools
# This playbook checks which tools from binaries_to_check are installed on the system
# Reports installed tools with versions and missing tools

- hosts: localhost
  vars_files:
    - ../rhel-tools-role/vars/main.yml

  tasks:
    - name: Check which binaries are installed
      shell: "command -v {{ item }} && {{ item }} --version 2>&1 | head -n 1 || echo 'not_found'"
      loop: "{{ binaries_to_check }}"
      register: binary_checks
      changed_when: false
      failed_when: false

    - name: Initialize results
      set_fact:
        installed_tools: []
        missing_tools: []

    - name: Process installed binaries
      set_fact:
        installed_tools: "{{ installed_tools + [{'name': item.item, 'version': item.stdout_lines[0] if 'not_found' not in item.stdout else 'N/A'}] }}"
      when: "'not_found' not in item.stdout"
      loop: "{{ binary_checks.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Collect missing binaries
      set_fact:
        missing_tools: "{{ missing_tools + [item.item] }}"
      when: "'not_found' in item.stdout"
      loop: "{{ binary_checks.results }}"
      loop_control:
        label: "{{ item.item }}"

    # Display Results
    - name: Display test header
      debug:
        msg:
          - "=========================================="
          - "     SYSTEM INSTALLED TOOLS REPORT"
          - "=========================================="

    - name: Display installed tools header
      debug:
        msg:
          - ""
          - "========== INSTALLED TOOLS =========="

    - name: Display installed tools
      debug:
        msg: "✓ {{ item.name | upper }}: {{ item.version }}"
      loop: "{{ installed_tools }}"
      when: installed_tools | length > 0

    - name: Display no installed tools message
      debug:
        msg: "  No tools installed"
      when: installed_tools | length == 0

    - name: Display missing tools header
      debug:
        msg:
          - ""
          - "========== MISSING TOOLS =========="

    - name: Display missing tools
      debug:
        msg: "✗ {{ item | upper }}: Not installed on system"
      loop: "{{ missing_tools }}"
      when: missing_tools | length > 0

    - name: Display no missing tools message
      debug:
        msg: "  All tools are installed!"
      when: missing_tools | length == 0

    - name: Display summary
      debug:
        msg:
          - ""
          - "=========================================="
          - "SUMMARY:"
          - ""
          - "  ✓ Installed: {{ installed_tools | length }}"
          - "  ✗ Missing: {{ missing_tools | length }}{% if missing_tools | length > 0 %} ({{ missing_tools | join(', ') }}){% endif %}"
          - "  Total: {{ binaries_to_check | length }}"
          - "=========================================="
