# ------------------------------
# 1. Create project build directories
# ------------------------------
- name: Ensure build directories exist in project
  delegate_to: localhost
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
  - "{{ build_dir }}"
  - "{{ local_download_dir }}"

# ------------------------------
# 2. Download Podman tarball
# ------------------------------
- name: Download Podman tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ podman_download_url }}"
    dest: "{{ local_download_dir }}/podman.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: podman_download

# ------------------------------
# 3. Download Skopeo tarball
# ------------------------------
- name: Download Skopeo source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ skopeo_download_url }}"
    dest: "{{ local_download_dir }}/skopeo.tar.gz"
    mode: '0644'
    validate_certs: false
    timeout: 300
    force: false
  register: skopeo_download

# ------------------------------
# 4. Download httpd tarball
# ------------------------------
- name: Download httpd tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ httpd_download_url }}"
    dest: "{{ local_download_dir }}/httpd.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: httpd_download

# ------------------------------
# 5. Download httpd-tools RPM
# ------------------------------
- name: Find latest httpd-tools rpm on mirror
  shell: |
    curl -s {{ almalinux_appstream_repo_url }} \
    | grep -oP 'httpd-tools-[^"]+\.rpm' \
    | sort -V | tail -n 1
  register: httpd_tools_filename

- name: Download httpd-tools RPM
  delegate_to: localhost
  get_url:
    url: "{{ almalinux_appstream_repo_url }}{{ httpd_tools_filename.stdout }}"
    dest: "{{ local_download_dir }}/httpd-tools.rpm"
    mode: '0644'
    force: false
    timeout: 300
    validate_certs: no

# ------------------------------
# 6. Download firewalld RPM
# ------------------------------
- name: Find latest firewalld rpm on AlmaLinux mirror
  shell: |
    curl -s {{ almalinux_baseos_repo_url }} \
    | grep -oP 'firewalld-[0-9][^"]+\.rpm' \
    | sort -V | tail -n 1
  register: firewalld_filename
  changed_when: false

- name: Download firewalld RPM on control node
  delegate_to: localhost
  get_url:
    url: "{{ almalinux_baseos_repo_url }}{{ firewalld_filename.stdout }}"
    dest: "{{ local_download_dir }}/firewalld.rpm"
    mode: '0644'
    validate_certs: false
    timeout: 300
    force: false
  register: firewalld_download

# ------------------------------
# 7. Download dnsmasq RPM
# ------------------------------
- name: Find latest dnsmasq rpm (AlmaLinux 10)
  shell: |
    curl -s {{ almalinux_appstream_repo_url }} \
    | grep -o 'dnsmasq-[0-9A-Za-z._-]*\.rpm' \
    | sort -V | tail -n 1
  register: dnsmasq_filename
  changed_when: false

- name: Debug the filename
  debug:
    var: dnsmasq_filename.stdout

- name: Download dnsmasq RPM on control node
  delegate_to: localhost
  get_url:
    url: "{{ almalinux_appstream_repo_url }}{{ dnsmasq_filename.stdout }}"
    dest: "{{ local_download_dir }}/dnsmasq.rpm"
    mode: '0644'
    validate_certs: false
    timeout: 300
    force: false

# ------------------------------
# 8. Download git source tarball
# ------------------------------
- name: Download git source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ git_download_url }}"
    dest: "{{ local_download_dir }}/git.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: git_download

# ------------------------------
# 9. Download wget source tarball
# ------------------------------
- name: Download wget source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ wget_download_url }}"
    dest: "{{ local_download_dir }}/wget.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: wget_download

# ------------------------------
# 10. Download curl source tarball
# ------------------------------
- name: Download curl source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ curl_download_url }}"
    dest: "{{ local_download_dir }}/curl.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: curl_download

# ------------------------------
# 11. Download vim source tarball
# ------------------------------
- name: Download vim source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ vim_download_url }}"
    dest: "{{ local_download_dir }}/vim.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: vim_download

# ------------------------------
# 12. Download bind-utils RPM
# ------------------------------
- name: Find latest bind-utils rpm (AlmaLinux 10)
  shell: |
    curl -s {{ almalinux_baseos_repo_url }} \
    | grep -o 'bind-utils-[0-9A-Za-z._-]*\.rpm' \
    | sort -V | tail -n 1
  register: bindutils_filename
  changed_when: false

- name: Debug bind-utils filename
  debug:
    var: bindutils_filename.stdout

- name: Download bind-utils RPM on control node
  delegate_to: localhost
  get_url:
    url: "{{ almalinux_baseos_repo_url }}{{ bindutils_filename.stdout }}"
    dest: "{{ local_download_dir }}/bind-utils.rpm"
    mode: '0644'
    validate_certs: false
    timeout: 300
    force: false
  register: bind_utils_download

# ------------------------------
# 13. Download telnet RPM
# ------------------------------
- name: Download telnet RPM on control node
  delegate_to: localhost
  get_url:
    url: "{{ telnet_download_url }}"
    dest: "{{ local_download_dir }}/telnet.rpm"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: telnet_download

# ------------------------------
# 14. Download jq binary
# ------------------------------
- name: Download jq binary on control node
  delegate_to: localhost
  get_url:
    url: "{{ jq_download_url }}"
    dest: "{{ local_download_dir }}/jq"
    mode: '0755'
    validate_certs: false
    force: false
    timeout: 300
  register: jq_download

# ------------------------------
# 15. Download buildah source tarball
# ------------------------------
- name: Download buildah source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ buildah_download_url }}"
    dest: "{{ local_download_dir }}/buildah.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: buildah_download

# ------------------------------
# 16. Download openssl source tarball
# ------------------------------
- name: Download openssl source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ openssl_download_url }}"
    dest: "{{ local_download_dir }}/openssl.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: openssl_download

# ------------------------------
# 17. Download helm tarball
# ------------------------------
- name: Download helm tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ helm_download_url }}"
    dest: "{{ local_download_dir }}/helm.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: helm_download

# ------------------------------
# 18. Download haproxy source tarball
# ------------------------------
- name: Download haproxy source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ haproxy_download_url }}"
    dest: "{{ local_download_dir }}/haproxy.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: haproxy_download

# ------------------------------
# 19. Download rsync source tarball
# ------------------------------
- name: Download rsync source tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ rsync_download_url }}"
    dest: "{{ local_download_dir }}/rsync.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: rsync_download

# ------------------------------
# 20. Download OC client tarball
# ------------------------------
- name: Download OC client tarball on control node
  delegate_to: localhost
  get_url:
    url: "{{ oc_client_download_url }}"
    dest: "{{ local_download_dir }}/oc.tar.gz"
    mode: '0644'
    validate_certs: false
    force: false
    timeout: 300
  register: oc_download

# ------------------------------
# 21. Create tarball of all downloads
# ------------------------------
- name: Create tarball with all downloaded dependencies
  delegate_to: localhost
  archive:
    path: "{{ local_download_dir }}"
    dest: "{{ local_combined_tar }}"
    format: gz
    mode: '0644'
  register: combined_tar

# ------------------------------
# 22. Display tarball information
# ------------------------------
- name: Get combined tarball stats
  delegate_to: localhost
  stat:
    path: "{{ local_combined_tar }}"
  register: tar_stats

- name: Display combined tarball information
  delegate_to: localhost
  debug:
    msg:
    - "Combined tarball created successfully"
    - "Location: {{ local_combined_tar }}"
    - "Size: {{ (tar_stats.stat.size / 1024 / 1024) | round(2) }} MB"
  run_once: true
