#SPDX-License-Identifier: MIT-0
---
# ==============================
# Test Tar Operations
# ==============================
# This subtask tests the create_tar_file, copy_tar, and extract_tar operations

# ------------------------------
# Test 1: Verify Combined Tar File Creation
# ------------------------------
- name: Check if combined tar file exists on control node
  delegate_to: localhost
  stat:
    path: "{{ local_combined_tar }}"
  register: local_tar_stat

- name: Assert combined tar file exists on control node
  assert:
    that:
      - local_tar_stat.stat.exists
      - local_tar_stat.stat.isreg
    fail_msg: "Combined tar file does not exist at {{ local_combined_tar }}"
    success_msg: "Combined tar file exists on control node"

- name: Display combined tar file size
  debug:
    msg: "Combined tar file size: {{ (local_tar_stat.stat.size / 1024 / 1024) | round(2) }} MB"

# ------------------------------
# Test 2: Verify Tar File Copy to Remote
# ------------------------------
- name: Check if tar file exists on target node
  stat:
    path: "{{ remote_tar_file }}"
  register: remote_tar_stat

- name: Assert tar file exists on target node
  assert:
    that:
      - remote_tar_stat.stat.exists
      - remote_tar_stat.stat.isreg
    fail_msg: "Tar file does not exist on target node at {{ remote_tar_file }}"
    success_msg: "Tar file successfully copied to target node"

- name: Verify tar file size matches on remote
  assert:
    that:
      - remote_tar_stat.stat.size == local_tar_stat.stat.size
    fail_msg: "Remote tar file size ({{ remote_tar_stat.stat.size }}) does not match local ({{ local_tar_stat.stat.size }})"
    success_msg: "Remote tar file size matches local file"

# ------------------------------
# Test 3: Verify Tar File Extraction
# ------------------------------
- name: Check if extraction directory exists on control node
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}"
  register: extract_dir_stat

- name: Assert extraction directory exists
  assert:
    that:
      - extract_dir_stat.stat.exists
      - extract_dir_stat.stat.isdir
    fail_msg: "Extraction directory does not exist at {{ local_extract_dir }}"
    success_msg: "Extraction directory exists on control node"

- name: List contents of extraction directory
  delegate_to: localhost
  shell: ls -la {{ local_extract_dir }}
  register: extract_contents
  changed_when: false

- name: Display extraction directory contents
  debug:
    var: extract_contents.stdout_lines

# ------------------------------
# Test 4: Verify Key Files Were Extracted
# ------------------------------
- name: Check for extracted podman binary (nested bin/bin)
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/bin/bin/podman-remote-static-linux_amd64"
  register: podman_extracted

- name: Check for extracted jq binary in bin directory
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/bin/jq"
  register: jq_extracted

- name: Check for extracted helm binary in bin directory
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/bin/helm"
  register: helm_extracted

- name: Check for extracted httpd directory
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/httpd"
  register: httpd_extracted

- name: Check for skopeo source directory
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/skopeo-1.17.0"
  register: skopeo_extracted

- name: Assert critical files/directories were extracted
  assert:
    that:
      - podman_extracted.stat.exists
      - jq_extracted.stat.exists
      - helm_extracted.stat.exists
      - httpd_extracted.stat.exists
      - httpd_extracted.stat.isdir
      - skopeo_extracted.stat.exists
      - skopeo_extracted.stat.isdir
    fail_msg: "Some critical files/directories were not extracted properly"
    success_msg: "Critical files/directories were successfully extracted"

# ------------------------------
# Test 5: Verify Tar File Integrity
# ------------------------------
- name: Test tar file integrity on remote
  shell: tar -tzf {{ remote_tar_file }} > /dev/null
  register: tar_integrity_check
  changed_when: false
  failed_when: tar_integrity_check.rc != 0

- name: Count files in remote tar
  shell: tar -tzf {{ remote_tar_file }} | wc -l
  register: tar_file_count
  changed_when: false

- name: Display tar file count
  debug:
    msg: "Tar archive contains {{ tar_file_count.stdout }} files/directories"

- name: Verify tar contains expected number of files
  assert:
    that:
      - tar_file_count.stdout | int > 0
    fail_msg: "Tar file appears to be empty"
    success_msg: "Tar file contains files"

# ------------------------------
# Test 6: Verify Downloaded Files Integrity
# ------------------------------
- name: Verify downloaded files are valid archives/binaries
  delegate_to: localhost
  shell: file {{ local_download_dir }}/{{ item }}
  loop:
    - podman.tar.gz
    - httpd.tar.gz
    - git.tar.gz
    - wget.tar.gz
    - curl.tar.gz
    - vim.tar.gz
    - openssl.tar.gz
    - helm.tar.gz
    - haproxy.tar.gz
    - rsync.tar.gz
    - jq
  register: file_types
  changed_when: false
  failed_when: false

- name: Display file types of downloaded files
  debug:
    msg: "{{ item.item }}: {{ item.stdout }}"
  loop: "{{ file_types.results }}"
  when: item.rc == 0

- name: Verify gzip compressed files
  assert:
    that:
      - item.stdout is search('gzip compressed') or item.stdout is search('executable')
    fail_msg: "{{ item.item }} is not a valid gzip archive or executable"
    success_msg: "{{ item.item }} is a valid file"
  loop: "{{ file_types.results }}"
  when: item.rc == 0 and item.item != 'jq'

- name: Check sizes of downloaded files
  delegate_to: localhost
  stat:
    path: "{{ local_download_dir }}/{{ item }}"
  loop:
    - podman.tar.gz
    - httpd.tar.gz
    - jq
  register: download_sizes

- name: Verify downloaded files are not empty
  assert:
    that:
      - item.stat.size > 1024
    fail_msg: "{{ item.item }} is too small ({{ item.stat.size }} bytes), may be corrupt"
    success_msg: "{{ item.item }} size: {{ (item.stat.size / 1024 / 1024) | round(2) }} MB"
  loop: "{{ download_sizes.results }}"

# ------------------------------
# Test 7: Verify Extracted Files Integrity
# ------------------------------
- name: Check extracted source directories exist
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/{{ item }}"
  loop:
    - httpd
    - git
    - wget
    - curl
    - vim
    - openssl
    - haproxy
    - rsync
  register: extracted_source_dirs

- name: Display extracted source directories
  debug:
    msg: "{{ item.item }} directory exists: {{ item.stat.exists }}"
  loop: "{{ extracted_source_dirs.results }}"

- name: Assert source directories were extracted
  assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "{{ item.item }} directory is missing"
    success_msg: "{{ item.item }} directory exists"
  loop: "{{ extracted_source_dirs.results }}"

- name: Verify RPM extraction directories exist
  delegate_to: localhost
  stat:
    path: "{{ local_extract_dir }}/{{ item }}"
  loop:
    - httpd-tools
    - firewalld
    - dnsmasq
    - bind-utils
  register: rpm_dirs

- name: Check if RPM directories have content
  delegate_to: localhost
  shell: find {{ local_extract_dir }}/{{ item }} -type f | wc -l
  loop:
    - httpd-tools
    - firewalld
    - dnsmasq
    - bind-utils
  register: rpm_file_counts
  changed_when: false

- name: Display RPM extraction status
  debug:
    msg: "{{ item.item }} directory has {{ item.stdout }} files extracted"
  loop: "{{ rpm_file_counts.results }}"

- name: Assert RPM extraction directories exist
  assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "{{ item.item }} RPM extraction directory is missing"
    success_msg: "{{ item.item }} RPM extraction directory exists"
  loop: "{{ rpm_dirs.results }}"

- name: Warn if RPM directories are empty (non-fatal)
  debug:
    msg: "WARNING: {{ item.item }} directory exists but appears to be empty ({{ item.stdout }} files)"
  loop: "{{ rpm_file_counts.results }}"
  when: item.stdout | int == 0

# ------------------------------
# Test 8: Version Detection
# ------------------------------
- name: Extract version information from filenames
  set_fact:
    version_info:
      podman: "{{ podman_download_url | regex_search('v([0-9.]+)', '\\1') | first }}"
      httpd: "{{ httpd_download_url | regex_search('httpd-([0-9.]+)', '\\1') | first }}"
      git: "{{ git_download_url | regex_search('git-([0-9.]+)', '\\1') | first }}"
      wget: "{{ wget_download_url | regex_search('wget-([0-9.]+)', '\\1') | first }}"
      curl: "{{ curl_download_url | regex_search('curl-([0-9.]+)', '\\1') | first }}"
      vim: "{{ vim_download_url | regex_search('vim-([0-9.]+)', '\\1') | first }}"
      openssl: "{{ openssl_download_url | regex_search('openssl-([0-9.]+)', '\\1') | first }}"
      helm: "{{ helm_download_url | regex_search('helm-v([0-9.]+)', '\\1') | first }}"
      haproxy: "{{ haproxy_download_url | regex_search('haproxy-([0-9.]+)', '\\1') | first }}"
      rsync: "{{ rsync_download_url | regex_search('rsync-([0-9.]+)', '\\1') | first }}"

- name: Display detected versions
  debug:
    msg: "{{ item.key }}: v{{ item.value }}"
  loop: "{{ version_info | dict2items }}"

- name: Verify version numbers are valid
  assert:
    that:
      - item.value | length > 0
      - item.value is match('[0-9]+\.[0-9]+.*')
    fail_msg: "{{ item.key }} version could not be detected or is invalid"
    success_msg: "{{ item.key }} version {{ item.value }} detected"
  loop: "{{ version_info | dict2items }}"

# ------------------------------
# Test 9: Validate Archive Contents
# ------------------------------
- name: Count files in each downloaded tarball
  delegate_to: localhost
  shell: tar -tzf {{ local_download_dir }}/{{ item }} | wc -l
  loop:
    - podman.tar.gz
    - httpd.tar.gz
    - git.tar.gz
  register: individual_tar_counts
  changed_when: false

- name: Display individual tarball file counts
  debug:
    msg: "{{ item.item }} contains {{ item.stdout }} files/directories"
  loop: "{{ individual_tar_counts.results }}"

- name: Verify tarballs are not empty
  assert:
    that:
      - item.stdout | int > 0
    fail_msg: "{{ item.item }} appears to be empty"
    success_msg: "{{ item.item }} contains {{ item.stdout }} items"
  loop: "{{ individual_tar_counts.results }}"

# ------------------------------
# Test 10: Checksum Validation (Optional)
# ------------------------------
- name: Generate checksums for downloaded files
  delegate_to: localhost
  shell: sha256sum {{ local_download_dir }}/{{ item }} | awk '{print $1}'
  loop:
    - podman.tar.gz
    - jq
    - httpd.tar.gz
  register: checksums
  changed_when: false

- name: Display checksums
  debug:
    msg: "{{ item.item }} SHA256: {{ item.stdout }}"
  loop: "{{ checksums.results }}"

# ------------------------------
# Test Summary
# ------------------------------
- name: Display test summary
  debug:
    msg:
      - "========== TAR OPERATIONS TEST SUMMARY =========="
      - "✓ Combined tar file created: {{ local_combined_tar }}"
      - "✓ Tar file size: {{ (local_tar_stat.stat.size / 1024 / 1024) | round(2) }} MB"
      - "✓ Tar file copied to remote: {{ remote_tar_file }}"
      - "✓ Files extracted to: {{ local_extract_dir }}"
      - "✓ Files in archive: {{ tar_file_count.stdout }}"
      - "✓ Downloaded files validated: All files are valid archives/binaries"
      - "✓ Extracted files validated: All source directories and RPMs present"
      - "✓ Version information detected for all tools"
      - "✓ Checksums generated for verification"
      - "✓ All tar operations completed successfully"
      - "================================================="
