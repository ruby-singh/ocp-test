# 1) Check if image exists on target host
- name: Check if image exists on target host (remote)
  shell: podman image exists {{ registry_image }}
  register: target_host_image_check
  failed_when: false
  changed_when: false

- name: Debug target host image check result
  debug:
    msg: "Target host 'podman image exists {{ registry_image }}' returned rc={{ target_host_image_check.rc }}"

# 2) If missing on target host, ensure it's available locally
- name: Check if image exists on control node (localhost)
  delegate_to: localhost
  shell: podman image exists {{ registry_image }}
  register: control_node_image_check
  failed_when: false
  changed_when: false
  when: target_host_image_check.rc != 0

- name: Debug control node image check result
  debug:
    msg: "Control node 'podman image exists {{ registry_image }}' returned rc={{ control_node_image_check.rc }}"
  when: target_host_image_check.rc != 0

- name: Verify image is now present on target host1
  shell: podman image exists {{ registry_image }}
  register: final_image_check
  failed_when: final_image_check.rc != 0
  changed_when: false

- name: Pull image on control node if missing
  delegate_to: localhost
  shell: podman pull {{ registry_image }}
  when:
  - target_host_image_check.rc != 0
  - control_node_image_check.rc != 0
  register: image_pull_result

- debug:
    var: role_path

# 3) Save image on control node
- name: Ensure files directory exists on control node
  delegate_to: localhost
  file:
    path: "{{ role_path }}/files"
    state: directory
    mode: '0755'
  when: image_pull_result == 0

- name: Save image to tar
  delegate_to: localhost
  shell: podman save {{ registry_image }} -o {{ role_path }}/files/{{ image_tar }}
  when: image_pull_result.rc == 0

# 4) Transfer tarball to remote
- name: Copy image tar to remote
  copy:
    src: "{{ role_path }}/files/{{ image_tar }}"
    dest: "/tmp/{{ image_tar }}"
  when: target_host_image_check.rc != 0

# 5) Load image on remote host
- name: Load image on remote
  shell: podman load -i /tmp/{{ image_tar }}
  when: target_host_image_check.rc != 0

# At this point the image should be present on the target host
- name: Verify image is now present on target host
  shell: podman image exists {{ registry_image }}
  register: final_image_check
  failed_when: final_image_check.rc != 0
  changed_when: false
